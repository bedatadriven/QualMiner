
```{r tabset, results='asis'}
fill.colors <- color_set_16()
partner.names <- unique(PartnerSubProp$partnerName)
bodies <- list()
PartnerSubProp_sub <- list()
percents <- list()
legend <- list()
for (p in seq_along(partner.names)) {
  PartnerSubProp_sub[[p]] <- PartnerSubProp %>% dplyr::filter(partnerName == partner.names[p]) %>% arrange(desc(prop))
  percents[[p]] <- paste(sapply(seq_along(PartnerSubProp_sub[[p]]$subPartnerName), function(i) {
    sprintf("%s: %s", PartnerSubProp_sub[[p]]$subPartnerName[i], PartnerSubProp_sub[[p]]$percent[i])
  }), collapse = ", ")
  legend[[p]] <- if (length(PartnerSubProp_sub[[p]][["subPartnerName"]]) > 1) {
    "legend.position = \"right\"" 
  }  else {
    "legend.position = \"none\""
  }
  bodies[[p]] <- glue::glue('
  PartnerSubProp_sub[[{p}]] %>% 
    ggplot(aes(x=partnerName, y=prop, fill=reorder(subPartnerName, -prop))) +
    geom_bar(position="dodge", stat="identity", color="black") +
    labs(
      title = "{partner.name}",
      subtitle = stringr::str_wrap("{percent}", width = 60)
    ) +
    xlab(NULL) +
    ylab(NULL) +
    theme_ecuador1() +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      legend.title=element_blank(),
      {include.legend}
    ) +
    scale_fill_manual(values = fill.colors)
  ',
  p = p,
  partner.name = partner.names[p],
  percent = percents[[p]],
  include.legend = legend[[p]]
  )
}
create_tabset(
  main = "### Which partners and sub-partners are reporting?", 
  tabs = partner.names, 
  body = bodies
)
```

